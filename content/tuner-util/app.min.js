"use strict";class t{isEnabled=!1;#t;#e;constructor(t,e,n){this.#t=t,this.#e=e,e.port.start(),e.port.addEventListener("message",(t=>{this.isEnabled&&n[t.data.kind]?.(t.data.value)}))}toggleEnabled(t){this.isEnabled="boolean"==typeof t?t:!this.isEnabled,this.#e.port.postMessage({kind:"enable",value:this.isEnabled})}destroy(){this.#t.close()}static async create({context:e,processor:n,callbacks:i}){await e.audioWorklet.addModule("worklet.min.js");const o=new AudioWorkletNode(e,n,{channelCount:1,channelCountMode:"explicit",numberOfInputs:1,numberOfOutputs:0}),s=await navigator.mediaDevices.getUserMedia({video:!1,audio:{autoGainControl:!1,echoCancellation:!1,noiseSuppression:!1}});return e.createMediaStreamSource(s).connect(o),new t(e,o,i)}}class e{width=0;height=0;options;#n;#i;#t;#o;#s;constructor(t,e,n,i){this.options=i,this.#n=t,this.#i=e,this.#t=n,this.#s=t=>{this.#o=void 0,0===this.width&&0===this.height&&this.updateLayout(),n.save(),this.clear(),n.translate(.5,.5),this.render?.(n,t),n.restore()}}clear(){this.#t.clearRect(0,0,this.width,this.height),this.#o&&(cancelAnimationFrame(this.#o),this.#o=void 0)}updateLayout(){const t=this.#n.getBoundingClientRect();this.width=Math.floor(t.width*devicePixelRatio),this.height=Math.floor(t.height*devicePixelRatio),this.#i.width=this.width,this.#i.height=this.height,this.#i.style.width=`${t.width}px`,this.#i.style.height=`${t.height}px`}scheduleFrame(){this.#o??=requestAnimationFrame(this.#s)}static create(t,e,n={}){const i=document.querySelector(e),o=i.firstElementChild,s=o.getContext("2d");return new t(i,o,s,n)}}class n extends e{#a;update(t){this.#a=t,this.scheduleFrame()}render(t){const e=this.#a,n=this.width/e.length,i=n-1*devicePixelRatio,o=i/2,s=Math.floor(this.height/2),a=s-o-1*devicePixelRatio;t.fillStyle=this.options.color;for(let r=0;r<e.length;++r){const c=r*n,h=c+o,d=c+i,l=e[r]*a;t.beginPath(),t.moveTo(c,s),t.arcTo(c,s-l-o,h,s-l-o,o),t.arcTo(d,s-l-o,d,s,o),t.arcTo(d,s+l+o,h,s+l+o,o),t.arcTo(c,s+l+o,c,s,o),t.closePath(),t.fill()}}}const i=/^([a-g]#?)(\d+)$/i,o={a:9,A:9,"a#":10,"A#":10,b:11,B:11,c:0,C:0,"c#":1,"C#":1,d:2,D:2,"d#":3,"D#":3,e:4,E:4,f:5,F:5,"f#":6,"F#":6,g:7,G:7,"g#":8,"G#":8},s=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function a(t,e=440){return 12*Math.log(t/e)/Math.LN2+69}function r(t){return s[t%12]+Math.floor(t/12-1)}function c(t,e=440){return Math.round(100*2**((t-69)/12)*e)/100}class h{#t;#r;#c;constructor(t,e,n){this.#t=t,this.#r=e,this.#c=n}destroy(){this.#t?.close()}emit(t){const e=this.#t.currentTime;this.#r.frequency.setValueAtTime(t,e),this.#c.gain.cancelScheduledValues(e),this.#c.gain.setTargetAtTime(1,e,.001),this.#c.gain.setTargetAtTime(0,e+.1,.1)}static create(t){const e=t.createOscillator(),n=t.createGain();return n.gain.value=0,e.connect(n),n.connect(t.destination),e.start(),new h(t,e,n)}}class d{#h;constructor(t){let e,n,i;const o=()=>{e=void 0;for(const e of t){const t=e.getBoundingClientRect();e.style.setProperty("--fx-offset-x",100*(n-t.left)/t.width+"%"),e.style.setProperty("--fx-offset-y",100*(i-t.top)/t.height+"%")}};this.#h=t=>{"mouse"===t.pointerType&&(n=t.clientX,i=t.clientY,e??=requestAnimationFrame(o))},window.addEventListener("pointermove",this.#h,{passive:!0})}destroy(){window.removeEventListener("pointermove",this.#h)}static create(t){return new d(document.querySelectorAll(t))}}class l extends e{#d=0;#l=0;update(t,e){const n=Math.round(a(t,e)),i=c(n,e);this.#l=(t-i)/(t<i?i-c(n-1,e):c(n+1,e)-i),this.scheduleFrame()}render(t){const e=4*devicePixelRatio,n=1*devicePixelRatio,i=6*devicePixelRatio,o=4*devicePixelRatio;t.lineWidth=1*devicePixelRatio,t.strokeStyle=t.fillStyle=this.options.color;const s=[e,this.height],a=[this.width/2,i+n+e],r=function(t,e,n){const i=(t[0]+e[0])/2,o=(t[1]+e[1])/2,s=t[1]-e[1],a=e[0]-t[0],r=(e[0]+n[0])/2,c=(e[1]+n[1])/2,h=e[1]-n[1],d=n[0]-e[0],l=i-r,u=o-c,m=h*a-d*s;if(0==m)return null;const f=(l*a-u*s)/m;return[r+f*h,c+f*d]}(s,a,[this.width-e,this.height]),c=r[1]-a[1],h=Math.asin(1-(this.height-a[1])/c);t.beginPath(),t.arc(r[0],r[1],c,Math.PI-h,h,!1),t.stroke(),t.clearRect(r[0]-i,r[1]-c-i,2*i,2*i),t.beginPath(),t.arc(r[0],r[1]-c,i,0,2*Math.PI,!1),t.stroke();const d=this.#l-this.#d;this.#d+=.1*d,Math.abs(d)>Number.EPSILON?this.scheduleFrame():this.#d=this.#l;const l=Math.PI/2-(Math.PI/2-h)*this.#d;t.beginPath(),t.arc(r[0]+Math.cos(l)*c,r[1]-Math.sin(l)*c,o,0,2*Math.PI),t.fill()}}window.addEventListener("DOMContentLoaded",(()=>{const s=/^-?\d+$/,u=/^-?\d+(?:[.,]\d*)?$/;d.create(".fx-shiny");const m=e.create(l,"#tune-chart",{color:"#000"}),f=e.create(n,"#bin-chart",{color:"hsl(0,75%,63%)"});m.update(440);const p=document.getElementById("midi-box"),g=document.getElementById("midi-input"),v=document.getElementById("note-box"),w=document.getElementById("note-input"),b=document.getElementById("freq-box"),E=document.getElementById("freq-input");let x=69,y="A4",M=440;function P(){this.setSelectionRange(0,this.value.length)}function L(t=document){t.querySelectorAll(".input-wrapper__error").forEach((t=>{t.parentNode.removeChild(t)}))}function C(t,e){L(t);const n=document.createElement("span");n.classList.add("input-wrapper__error"),n.textContent=e,t.insertBefore(n,t.firstChild)}function I(t){const e=Math.round(t);if(e<21)throw new Error("value too low");if(e>127)throw new Error("value too high");return e}function R(t,e=!1){x=t,g.value=(e?"~ ":"")+t.toFixed(0)}function A(t,e=!1){y=t,w.value=(e?"~ ":"")+t}function k(t,e=2){M=t,E.value=t.toFixed(e)}function B(t,e){return Math.abs(c(t)-e)>.1}g.addEventListener("focus",P,!1),g.addEventListener("input",(()=>{try{const t=g.value;if(!s.test(t))throw new Error("invalid MIDI number");const e=I(Number(t)),n=c(e);L(),x=e,A(r(e)),k(n),m.update(n)}catch(t){C(p,t.message)}})),w.addEventListener("focus",P,!1),w.addEventListener("input",(()=>{try{const t=w.value,e=I(function(t){const e=i.exec(t);if(!e||!Object.hasOwn(o,e[1]))throw new Error("invalid note name");return 12+Math.trunc(12*Number(e[2]))+o[e[1]]}(t)),n=c(e);M=n,L(),R(e),y=t,k(n),m.update(n)}catch(t){C(v,t.message)}})),E.addEventListener("focus",P,!1),E.addEventListener("input",(()=>{try{const t=E.value;if(!u.test(t))throw new Error("invalid frequency value");const e=Number(t.replace(",",".")),n=I(a(e)),i=B(n,e);L(),R(n,i),A(r(n),i),M=e,m.update(e)}catch(t){C(b,t.message)}}));const F=document.getElementById("record-button");F.addEventListener("click",(async()=>{const e=await async function(){return N??=await t.create({context:O(),processor:"listener",callbacks:{bin(t){S.shift(),S.push(1-(1-t)**5),f.update(S)},pitch(t){const e=Math.round(a(t));if(e<21||e>127)return;const n=B(e,t);L(),R(e,n),A(r(e),n),k(t,0),m.update(t)}}})}();var n;e.toggleEnabled(),n=e.isEnabled,g.disabled=w.disabled=E.disabled=n,F.classList.toggle("button--active",e.isEnabled),e.isEnabled||f.clear()}));document.getElementById("ping-button").addEventListener("click",(()=>{(q??=h.create(O())).emit(M)}));const S=new Array(16).fill(0);let T,q,N;function O(){return T??=new AudioContext}}));
