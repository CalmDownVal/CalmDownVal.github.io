"use strict";class t{isEnabled=!1;#t;#e;constructor(t,e,n){this.#t=t,this.#e=e,e.port.start(),e.port.addEventListener("message",(t=>{this.isEnabled&&n[t.data.kind]?.(t.data.value)}))}toggleEnabled(t){this.isEnabled="boolean"==typeof t?t:!this.isEnabled,this.#e.port.postMessage({kind:"enable",value:this.isEnabled})}destroy(){this.#t.close()}static async create({context:e,processor:n,callbacks:i}){await e.audioWorklet.addModule("worklet.min.js");const o=new AudioWorkletNode(e,n,{channelCount:1,channelCountMode:"explicit",numberOfInputs:1,numberOfOutputs:0}),s=await navigator.mediaDevices.getUserMedia({video:!1,audio:{autoGainControl:!1,echoCancellation:!1,noiseSuppression:!1}});return e.createMediaStreamSource(s).connect(o),new t(e,o,i)}}class e{width=0;height=0;options;#n;#t;#i;#o;constructor(t,e,n,i){this.options=i,this.#n=e,this.#t=n,this.#o=t=>{this.#i=void 0,this.width<Number.EPSILON&&this.height<Number.EPSILON||(n.save(),this.clear(),n.translate(.5,.5),this.render?.(n,t),n.restore())};new ResizeObserver((t=>{const e=t[0].contentRect;this.width=Math.floor(e.width*devicePixelRatio),this.height=Math.floor(e.height*devicePixelRatio),this.#n.width=this.width,this.#n.height=this.height,this.#n.style.width=`${e.width}px`,this.#n.style.height=`${e.height}px`,this.#o()})).observe(t)}clear(){this.#t.clearRect(0,0,this.width,this.height),this.#i&&(cancelAnimationFrame(this.#i),this.#i=void 0)}scheduleFrame(){this.#i??=requestAnimationFrame(this.#o)}static create(t,e,n={}){const i=document.querySelector(e),o=i.firstElementChild,s=o.getContext("2d");return new t(i,o,s,n)}}class n extends e{#s;update(t){this.#s=t,this.scheduleFrame()}render(t){const e=this.#s;if(!e||0===e.length)return;const n=this.width/e.length,i=n-1*devicePixelRatio,o=i/2,s=Math.floor(this.height/2),r=s-o-1*devicePixelRatio;t.fillStyle=this.options.color;for(let a=0;a<e.length;++a){const c=a*n,d=c+o,h=c+i,l=e[a]*r;t.beginPath(),t.moveTo(c,s),t.arcTo(c,s-l-o,d,s-l-o,o),t.arcTo(h,s-l-o,h,s,o),t.arcTo(h,s+l+o,d,s+l+o,o),t.arcTo(c,s+l+o,c,s,o),t.closePath(),t.fill()}}}const i=/^([a-g]#?)(\d+)$/i,o={a:9,A:9,"a#":10,"A#":10,b:11,B:11,c:0,C:0,"c#":1,"C#":1,d:2,D:2,"d#":3,"D#":3,e:4,E:4,f:5,F:5,"f#":6,"F#":6,g:7,G:7,"g#":8,"G#":8},s=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function r(t,e=440){return Math.round(12*Math.log(t/e)/Math.LN2+69)}function a(t){const e=Math.trunc(t);return s[e%12]+Math.floor(e/12-1)}function c(t,e=440){return Math.round(100*2**((t-69)/12)*e)/100}class d{#t;#r;#a;constructor(t,e,n){this.#t=t,this.#r=e,this.#a=n}destroy(){this.#t?.close()}ping(t){this.on(t),this.off()}on(t){const e=this.#t.currentTime;this.#r.frequency.setValueAtTime(t,e),this.#a.gain.cancelScheduledValues(e),this.#a.gain.setTargetAtTime(1,e,.001)}off(){const t=this.#t.currentTime;this.#a.gain.setTargetAtTime(0,t+.1,.1)}static create(t){const e=t.createOscillator(),n=t.createGain();return n.gain.value=0,e.connect(n),n.connect(t.destination),e.start(),new d(t,e,n)}}class h{#c;constructor(t){let e,n,i;const o=()=>{e=void 0;for(const e of t){const t=e.getBoundingClientRect();e.style.setProperty("--fx-offset-x",100*(n-t.left)/t.width+"%"),e.style.setProperty("--fx-offset-y",100*(i-t.top)/t.height+"%")}};this.#c=t=>{"mouse"===t.pointerType&&(n=t.clientX,i=t.clientY,e??=requestAnimationFrame(o))},window.addEventListener("pointermove",this.#c,{passive:!0})}destroy(){window.removeEventListener("pointermove",this.#c)}static create(t){return new h(document.querySelectorAll(t))}}class l extends e{#d=0;#h=0;update(t,e){const n=Math.round(r(t,e)),i=c(n,e);this.#h=(t-i)/(t<i?i-c(n-1,e):c(n+1,e)-i),this.scheduleFrame()}render(t){const e=4*devicePixelRatio,n=1*devicePixelRatio,i=6*devicePixelRatio,o=4*devicePixelRatio;t.lineWidth=1*devicePixelRatio,t.strokeStyle=t.fillStyle=this.options.color;const s=[e,this.height],r=[this.width/2,i+n+e],a=function(t,e,n){const i=(t[0]+e[0])/2,o=(t[1]+e[1])/2,s=t[1]-e[1],r=e[0]-t[0],a=(e[0]+n[0])/2,c=(e[1]+n[1])/2,d=e[1]-n[1],h=n[0]-e[0],l=i-a,u=o-c,f=d*r-h*s;if(0===f)return null;const m=(l*r-u*s)/f;return[a+m*d,c+m*h]}(s,r,[this.width-e,this.height]),c=a[1]-r[1],d=Math.asin(1-(this.height-r[1])/c);t.beginPath(),t.arc(a[0],a[1],c,Math.PI-d,d,!1),t.stroke(),t.clearRect(a[0]-i,a[1]-c-i,2*i,2*i),t.beginPath(),t.arc(a[0],a[1]-c,i,0,2*Math.PI,!1),t.stroke();const h=this.#h-this.#d;this.#d+=.1*h,Math.abs(h)>Number.EPSILON?this.scheduleFrame():this.#d=this.#h;const l=Math.PI/2-(Math.PI/2-d)*this.#d;t.beginPath(),t.arc(a[0]+Math.cos(l)*c,a[1]-Math.sin(l)*c,o,0,2*Math.PI),t.fill()}}window.addEventListener("DOMContentLoaded",(()=>{const s=/^\d+$/,u=/^\d+(?:[.,]\d*)?$/,f=0,m=127,v="input-wrapper__error",g="input-wrapper--approx",p=440;h.create(".fx-shiny");const w=e.create(l,"#tune-chart",{color:"#000"}),b=e.create(n,"#bin-chart",{color:"hsl(0,75%,63%)"});w.update(440);const E=document.getElementById("midi-box"),x=document.getElementById("midi-input"),y=document.getElementById("note-box"),M=document.getElementById("note-input"),L=document.getElementById("freq-box"),P=document.getElementById("freq-input");let I=69,R=440;function k(t){E.classList.remove(g),y.classList.remove(g),B(c(I,p)),A(t)}function A(t){t.target.setSelectionRange(0,t.target.value.length)}function C(t=document){t.querySelectorAll(`.${v}`).forEach((t=>{t.parentNode.removeChild(t)}))}function S(t,e){C(t);const n=document.createElement("span");n.classList.add(v),n.textContent=e,t.insertBefore(n,t.firstChild)}function F(t,e=!1){I=t,x.value=t.toFixed(0),E.classList.toggle(g,e)}function T(t,e=!1){M.value=t,y.classList.toggle(g,e)}function B(t,e=2){R=t;const n=t.toFixed(e),i=/^(\d+)[.,]0*$/.exec(n);P.value=i?i[1]:n,w.update(t)}function N(t){return e=>{const n=e.target,i=n.value,o=n.selectionStart??i.length,s=n.selectionEnd??i.length,r=i.slice(0,o)+(e.data??"")+i.slice(s);t(r)||e.preventDefault()}}function D(t){return e=>{switch(e.code){case"ArrowUp":e.preventDefault(),t(1);break;case"ArrowDown":e.preventDefault(),t(-1)}}}function O(t){const e=function(t){return Math.min(Math.max(t,f),m)}(I+t);F(e),T(a(e)),B(c(e,p))}x.addEventListener("focus",k),x.addEventListener("keydown",D(O)),x.addEventListener("beforeinput",N((function(t){return s.test(t)}))),x.addEventListener("input",(()=>{try{const t=x.value;if(!s.test(t))throw new Error("invalid MIDI number");const e=z(Number(t)),n=c(e,p);C(),I=e,T(a(e)),B(n)}catch(t){S(E,t.message)}})),M.addEventListener("focus",k),M.addEventListener("keydown",D(O)),M.addEventListener("beforeinput",N((function(t){return/^[A-Ga-g]#?\d*$/.test(t)}))),M.addEventListener("input",(()=>{try{const t=z(function(t){const e=i.exec(t);if(!e||!Object.hasOwn(o,e[1]))throw new Error("invalid note name");return 12+Math.trunc(12*Number(e[2]))+o[e[1]]}(M.value)),e=c(t,p);C(),F(t),B(e)}catch(t){S(y,t.message)}})),P.addEventListener("focus",A),P.addEventListener("keydown",D((function(t){const e=function(t){const e=c(f,p),n=c(m,p);return Math.min(Math.max(t,e),n)}(R+t),n=r(e,p),i=X(n,e);F(n,i),T(a(n),i),B(e)}))),P.addEventListener("beforeinput",N((function(t){return u.test(t)}))),P.addEventListener("input",(()=>{try{const t=P.value;if(!u.test(t))throw new Error("invalid frequency value");const e=Number(t.replace(",",".")),n=z(r(e,p)),i=X(n,e);C(),F(n,i),T(a(n),i),R=e,w.update(e)}catch(t){S(L,t.message)}}));const q=document.getElementById("record-button");q.addEventListener("click",(async()=>{const e=await async function(){return U??=await t.create({context:V(),processor:"listener",callbacks:{bin(t){G.shift(),G.push(1-(1-t)**5),b.update(G)},pitch(t){const e=r(t,p);if(e<f||e>m)return;const n=X(e,t);C(),F(e,n),T(a(e),n),B(t,0),w.update(t)}}})}();var n;e.toggleEnabled(),n=e.isEnabled,x.disabled=M.disabled=P.disabled=n,q.classList.toggle("button--active",e.isEnabled),e.isEnabled||b.clear()}));const $=document.getElementById("ping-button");$.addEventListener("pointerdown",(()=>{_().on(R)})),$.addEventListener("pointerup",(()=>{_().off()}));const G=new Array(16).fill(0);let W,j,U;function V(){return W??=new AudioContext}function _(){return j??=d.create(V())}function z(t){if(t<f)throw new Error("value too low");if(t>m)throw new Error("value too high");return t}function X(t,e){return Math.abs(c(t,p)-e)>.1}}));
