"use strict";class t{width=0;height=0;options;#t;#e;#n;#i;constructor(t,e,n,i){this.options=i,this.#t=e,this.#e=n,this.#i=t=>{this.#n=void 0,this.width<Number.EPSILON&&this.height<Number.EPSILON||(n.save(),this.clear(),n.translate(.5,.5),this.render?.(n,t),n.restore())};new ResizeObserver((t=>{const e=t[0].contentRect;this.width=Math.floor(e.width*devicePixelRatio),this.height=Math.floor(e.height*devicePixelRatio),this.#t.width=this.width,this.#t.height=this.height,this.#t.style.width=`${e.width}px`,this.#t.style.height=`${e.height}px`,this.#i()})).observe(t)}clear(){this.#e.clearRect(0,0,this.width,this.height),this.#n&&(cancelAnimationFrame(this.#n),this.#n=void 0)}scheduleFrame(){this.#n??=requestAnimationFrame(this.#i)}static create(t,e,n={}){const i=document.querySelector(e),o=i.firstElementChild,s=o.getContext("2d");return new t(i,o,s,n)}}class e extends t{#o;update(t){this.#o=t,this.scheduleFrame()}render(t){const e=this.#o;if(!e||0===e.length)return;const n=this.width/e.length,i=n-1*devicePixelRatio,o=i/2,s=Math.floor(this.height/2),r=s-o-1*devicePixelRatio;t.fillStyle=this.options.color;for(let a=0;a<e.length;++a){const c=a*n,d=c+o,h=c+i,l=e[a]*r;t.beginPath(),t.moveTo(c,s),t.arcTo(c,s-l-o,d,s-l-o,o),t.arcTo(h,s-l-o,h,s,o),t.arcTo(h,s+l+o,d,s+l+o,o),t.arcTo(c,s+l+o,c,s,o),t.closePath(),t.fill()}}}const n=/^([a-g]#?)(\d+)$/i,i={a:9,A:9,"a#":10,"A#":10,b:11,B:11,c:0,C:0,"c#":1,"C#":1,d:2,D:2,"d#":3,"D#":3,e:4,E:4,f:5,F:5,"f#":6,"F#":6,g:7,G:7,"g#":8,"G#":8},o=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function s(t,e=440){return Math.round(12*Math.log(t/e)/Math.LN2+69)}function r(t){const e=Math.trunc(t);return o[e%12]+Math.floor(e/12-1)}function a(t,e=440){return Math.round(100*2**((t-69)/12)*e)/100}class c{isEnabled=!1;#e;#s;constructor(t,e,n){this.#e=t,this.#s=e,e.port.start(),e.port.addEventListener("message",(t=>{this.isEnabled&&n[t.data.kind]?.(t.data.value)}))}toggleEnabled(t){this.isEnabled="boolean"==typeof t?t:!this.isEnabled,this.#s.port.postMessage({kind:"enable",value:this.isEnabled})}destroy(){this.#e.close()}static async create({context:t,processor:e,callbacks:n}){await t.audioWorklet.addModule("worklet.min.js");const i=new AudioWorkletNode(t,e,{channelCount:1,channelCountMode:"explicit",numberOfInputs:1,numberOfOutputs:0}),o=await navigator.mediaDevices.getUserMedia({video:!1,audio:{autoGainControl:!1,echoCancellation:!1,noiseSuppression:!1}});return t.createMediaStreamSource(o).connect(i),new c(t,i,n)}}class d{#e;#r;#a;constructor(t,e,n){this.#e=t,this.#r=e,this.#a=n}destroy(){this.#e?.close()}ping(t){this.on(t),this.off()}on(t){const e=this.#e.currentTime;this.#r.frequency.setValueAtTime(t,e),this.#a.gain.cancelScheduledValues(e),this.#a.gain.setTargetAtTime(1,e,.001)}off(){const t=this.#e.currentTime;this.#a.gain.setTargetAtTime(0,t+.1,.1)}static create(t){const e=t.createOscillator(),n=t.createGain();return n.gain.value=0,e.connect(n),n.connect(t.destination),e.start(),new d(t,e,n)}}class h{#c;constructor(t){let e,n,i;const o=()=>{e=void 0;for(const e of t){const t=e.getBoundingClientRect();e.style.setProperty("--fx-offset-x",100*(n-t.left)/t.width+"%"),e.style.setProperty("--fx-offset-y",100*(i-t.top)/t.height+"%")}};this.#c=t=>{"mouse"===t.pointerType&&(n=t.clientX,i=t.clientY,e??=requestAnimationFrame(o))},window.addEventListener("pointermove",this.#c,{passive:!0})}destroy(){window.removeEventListener("pointermove",this.#c)}static create(t){return new h(document.querySelectorAll(t))}}class l extends t{#d=0;#h=0;update(t,e){const n=Math.round(s(t,e)),i=a(n,e);this.#h=(t-i)/(t<i?i-a(n-1,e):a(n+1,e)-i),this.scheduleFrame()}render(t){const e=4*devicePixelRatio,n=1*devicePixelRatio,i=6*devicePixelRatio,o=4*devicePixelRatio;t.lineWidth=1*devicePixelRatio,t.strokeStyle=t.fillStyle=this.options.color;const s=[e,this.height],r=[this.width/2,i+n+e],a=function(t,e,n){const i=(t[0]+e[0])/2,o=(t[1]+e[1])/2,s=t[1]-e[1],r=e[0]-t[0],a=(e[0]+n[0])/2,c=(e[1]+n[1])/2,d=e[1]-n[1],h=n[0]-e[0],l=i-a,u=o-c,f=d*r-h*s;if(0===f)return null;const m=(l*r-u*s)/f;return[a+m*d,c+m*h]}(s,r,[this.width-e,this.height]),c=a[1]-r[1],d=Math.asin(1-(this.height-r[1])/c);t.beginPath(),t.arc(a[0],a[1],c,Math.PI-d,d,!1),t.stroke(),t.clearRect(a[0]-i,a[1]-c-i,2*i,2*i),t.beginPath(),t.arc(a[0],a[1]-c,i,0,2*Math.PI,!1),t.stroke();const h=this.#h-this.#d;this.#d+=.1*h,Math.abs(h)>Number.EPSILON?this.scheduleFrame():this.#d=this.#h;const l=Math.PI/2-(Math.PI/2-d)*this.#d;t.beginPath(),t.arc(a[0]+Math.cos(l)*c,a[1]-Math.sin(l)*c,o,0,2*Math.PI),t.fill()}}window.addEventListener("DOMContentLoaded",(()=>{const o=/^\d+$/,u=/^\d+(?:[.,]\d*)?$/,f=0,m=127,v="input-wrapper__error",g="input-wrapper--approx",p=440;h.create(".fx-shiny");const w=t.create(l,"#tune-chart",{color:"#000"}),E=t.create(e,"#bin-chart",{color:"hsl(0,75%,63%)"});w.update(440);const b=document.getElementById("midi-box"),x=document.getElementById("midi-input"),y=document.getElementById("note-box"),M=document.getElementById("note-input"),L=document.getElementById("freq-box"),P=document.getElementById("freq-input");let k=69,I=440;function R(t){b.classList.remove(g),y.classList.remove(g),B(a(k,p)),A(t)}function A(t){t.target.setSelectionRange(0,t.target.value.length)}function C(t=document){t.querySelectorAll(`.${v}`).forEach((t=>{t.parentNode.removeChild(t)}))}function S(t,e){C(t);const n=document.createElement("span");n.classList.add(v),n.textContent=e,t.insertBefore(n,t.firstChild)}function T(t,e=!1){k=t,x.value=t.toFixed(0),b.classList.toggle(g,e)}function F(t,e=!1){M.value=t,y.classList.toggle(g,e)}function B(t,e=2){I=t;const n=t.toFixed(e),i=/^(\d+)[.,]0*$/.exec(n);P.value=i?i[1]:n,w.update(t)}function N(t){return e=>{const n=e.target,i=n.value,o=n.selectionStart??i.length,s=n.selectionEnd??i.length,r=i.slice(0,o)+(e.data??"")+i.slice(s);t(r)||e.preventDefault()}}function D(t){return e=>{switch(e.code){case"ArrowUp":e.preventDefault(),t(1);break;case"ArrowDown":e.preventDefault(),t(-1)}}}function O(t){const e=function(t){return Math.min(Math.max(t,f),m)}(k+t);T(e),F(r(e)),B(a(e,p))}x.addEventListener("focus",R),x.addEventListener("keydown",D(O)),x.addEventListener("beforeinput",N((function(t){return o.test(t)}))),x.addEventListener("input",(()=>{try{const t=x.value;if(!o.test(t))throw new Error("invalid MIDI number");const e=X(Number(t)),n=a(e,p);C(),k=e,F(r(e)),B(n)}catch(t){S(b,t.message)}})),M.addEventListener("focus",R),M.addEventListener("keydown",D(O)),M.addEventListener("beforeinput",N((function(t){return/^[A-Ga-g]#?\d*$/.test(t)}))),M.addEventListener("input",(()=>{try{const t=X(function(t){const e=n.exec(t);if(!e||!Object.hasOwn(i,e[1]))throw new Error("invalid note name");return 12+Math.trunc(12*Number(e[2]))+i[e[1]]}(M.value)),e=a(t,p);C(),T(t),B(e)}catch(t){S(y,t.message)}})),P.addEventListener("focus",A),P.addEventListener("keydown",D((function(t){const e=function(t){const e=a(f,p),n=a(m,p);return Math.min(Math.max(t,e),n)}(I+t),n=s(e,p),i=Y(n,e);T(n,i),F(r(n),i),B(e)}))),P.addEventListener("beforeinput",N((function(t){return u.test(t)}))),P.addEventListener("input",(()=>{try{const t=P.value;if(!u.test(t))throw new Error("invalid frequency value");const e=Number(t.replace(",",".")),n=X(s(e,p)),i=Y(n,e);C(),T(n,i),F(r(n),i),I=e,w.update(e)}catch(t){S(L,t.message)}}));const q=new Array(16).fill(0);let $,G,W;function j(){return $??=new AudioContext}function U(){return G??=d.create(j())}const V=document.getElementById("record-button");V.addEventListener("click",(async()=>{const t=await async function(){return W??=await c.create({context:j(),processor:"listener",callbacks:{bin(t){q.shift(),q.push(1-(1-t)**5),E.update(q)},pitch(t){const e=s(t,p);if(e<f||e>m)return;const n=Y(e,t);C(),T(e,n),F(r(e),n),B(t,0),w.update(t)}}})}();var e;t.toggleEnabled(),e=t.isEnabled,x.disabled=M.disabled=P.disabled=e,V.classList.toggle("button--active",t.isEnabled),t.isEnabled||E.clear()}));const _=document.getElementById("ping-button");let z=!1;function X(t){if(t<f)throw new Error("value too low");if(t>m)throw new Error("value too high");return t}function Y(t,e){return Math.abs(a(t,p)-e)>.1}_.addEventListener("click",(function t(){U().ping(I),setTimeout((()=>{z||"running"!==$.state||(_.removeEventListener("click",t),_.addEventListener("pointerdown",(()=>U().on(I))),_.addEventListener("pointerup",(()=>U().off())),z=!0)}),100)}))}));
