"use strict";class t{isEnabled=!1;#t;#e;constructor(t,e,i){this.#t=t,this.#e=e,e.port.start(),e.port.addEventListener("message",(t=>{this.isEnabled&&i[t.data.kind]?.(t.data.value)}))}toggleEnabled(t){this.isEnabled="boolean"==typeof t?t:!this.isEnabled,this.#e.port.postMessage({kind:"enable",value:this.isEnabled})}destroy(){this.#t.close()}static async create({context:e,processor:i,callbacks:n}){await e.audioWorklet.addModule("worklet.min.js");const s=new AudioWorkletNode(e,i,{channelCount:1,channelCountMode:"explicit",numberOfInputs:1,numberOfOutputs:0}),o=await navigator.mediaDevices.getUserMedia({video:!1,audio:{autoGainControl:!1,echoCancellation:!1,noiseSuppression:!1}});return e.createMediaStreamSource(o).connect(s),new t(e,s,n)}}class e{width=0;height=0;options;#i;#n;#t;#s;#o;constructor(t,e,i,n){this.options=n,this.#i=t,this.#n=e,this.#t=i,this.#o=t=>{this.#s=void 0,0===this.width&&0===this.height&&this.updateLayout(),i.save(),this.clear(),i.translate(.5,.5),this.render?.(i,t),i.restore()}}clear(){this.#t.clearRect(0,0,this.width,this.height),this.#s&&(cancelAnimationFrame(this.#s),this.#s=void 0)}updateLayout(){const t=this.#i.getBoundingClientRect();this.width=Math.floor(t.width*devicePixelRatio),this.height=Math.floor(t.height*devicePixelRatio),this.#n.width=this.width,this.#n.height=this.height,this.#n.style.width=`${t.width}px`,this.#n.style.height=`${t.height}px`}scheduleFrame(){this.#s??=requestAnimationFrame(this.#o)}static create(t,e,i={}){const n=document.querySelector(e),s=n.firstElementChild,o=s.getContext("2d");return new t(n,s,o,i)}}class i extends e{#a;update(t){this.#a=t,this.scheduleFrame()}render(t){const e=this.#a,i=this.width/e.length,n=i-1*devicePixelRatio,s=n/2,o=Math.floor(this.height/2),a=o-s-1*devicePixelRatio;t.fillStyle=this.options.color;for(let r=0;r<e.length;++r){const c=r*i,h=c+s,d=c+n,l=e[r]*a;t.beginPath(),t.moveTo(c,o),t.arcTo(c,o-l-s,h,o-l-s,s),t.arcTo(d,o-l-s,d,o,s),t.arcTo(d,o+l+s,h,o+l+s,s),t.arcTo(c,o+l+s,c,o,s),t.closePath(),t.fill()}}}const n=/^([a-g]#?)(\d+)$/i,s={a:9,A:9,"a#":10,"A#":10,b:11,B:11,c:0,C:0,"c#":1,"C#":1,d:2,D:2,"d#":3,"D#":3,e:4,E:4,f:5,F:5,"f#":6,"F#":6,g:7,G:7,"g#":8,"G#":8},o=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function a(t,e=440){return 12*Math.log(t/e)/Math.LN2+69}function r(t){return o[t%12]+Math.floor(t/12-1)}function c(t,e=440){return Math.round(100*2**((t-69)/12)*e)/100}class h{#t;#r;#c;constructor(t,e,i){this.#t=t,this.#r=e,this.#c=i}destroy(){this.#t?.close()}emit(t){const e=this.#t.currentTime;this.#r.frequency.setValueAtTime(t,e),this.#c.gain.cancelScheduledValues(e),this.#c.gain.setTargetAtTime(1,e,.001),this.#c.gain.setTargetAtTime(0,e+.1,.1)}static create(t){const e=t.createOscillator(),i=t.createGain();return i.gain.value=0,e.connect(i),i.connect(t.destination),e.start(),new h(t,e,i)}}class d{#h;constructor(t){let e,i,n;const s=()=>{e=void 0;for(const e of t){const t=e.getBoundingClientRect();e.style.setProperty("--fx-offset-x",100*(i-t.left)/t.width+"%"),e.style.setProperty("--fx-offset-y",100*(n-t.top)/t.height+"%")}};this.#h=t=>{"mouse"===t.pointerType&&(i=t.clientX,n=t.clientY,e??=requestAnimationFrame(s))},window.addEventListener("pointermove",this.#h,{passive:!0})}destroy(){window.removeEventListener("pointermove",this.#h)}static create(t){return new d(document.querySelectorAll(t))}}class l extends e{#d=0;#l=0;update(t,e){const i=Math.round(a(t,e)),n=c(i,e);this.#l=(t-n)/(t<n?n-c(i-1,e):c(i+1,e)-n),this.scheduleFrame()}render(t){const e=4*devicePixelRatio,i=1*devicePixelRatio,n=6*devicePixelRatio,s=4*devicePixelRatio;t.lineWidth=1*devicePixelRatio,t.strokeStyle=t.fillStyle=this.options.color;const o=e,a=this.height,r=this.width/2,c=n+i+e,h=this.width-e,d=this.height,l=r**2+d**2,u=.5*(o**2+a**2-l),p=.5*(l-h**2-d**2),m=(o-r)*(c-d)-(r-h)*(a-c),f=(u*(c-d)-p*(a-c))/m,v=(p*(o-r)-u*(r-h))/m,g=Math.sqrt((h-f)**2+(d-v)**2),w=Math.asin(1-(this.height-c)/g);t.beginPath(),t.arc(f,v,g,Math.PI-w,w,!1),t.stroke(),t.clearRect(f-n,v-g-n,2*n,2*n),t.beginPath(),t.arc(f,v-g,n,0,2*Math.PI,!1),t.stroke();const b=this.#l-this.#d;this.#d+=.1*b,Math.abs(b)>Number.EPSILON?this.scheduleFrame():this.#d=this.#l;const E=Math.PI/2-(Math.PI/2-w)*this.#d;t.beginPath(),t.arc(f+Math.cos(E)*g,v-Math.sin(E)*g,s,0,2*Math.PI),t.fill()}}window.addEventListener("DOMContentLoaded",(()=>{const o=/^-?\d+$/,u=/^-?\d+(?:[.,]\d*)?$/;d.create(".fx-shiny");const p=e.create(l,"#tune-chart",{color:"#000"}),m=e.create(i,"#bin-chart",{color:"hsl(0,75%,63%)"});p.update(440);const f=document.getElementById("midi-input"),v=document.getElementById("note-input"),g=document.getElementById("freq-input");let w=69,b="A4",E=440;function x(){this.setSelectionRange(0,this.value.length)}function y(t=document){t.querySelectorAll(".input-wrapper__error").forEach((t=>{t.parentNode.removeChild(t)}))}function M(t,e){const i=t.parentNode;y(i);const n=document.createElement("span");n.classList.add("input-wrapper__error"),n.textContent=e,i.insertBefore(n,i.firstChild)}function P(t){const e=Math.round(t);if(e<21)throw new Error("value too low");if(e>127)throw new Error("value too high");return e}function L(t,e=!1){w=t,f.value=(e?"~ ":"")+t.toFixed(0)}function C(t,e=!1){b=t,v.value=(e?"~ ":"")+t}function R(t,e=2){E=t,g.value=t.toFixed(e)}function A(t,e){return Math.abs(c(t)-e)>.1}f.addEventListener("focus",x,!1),f.addEventListener("input",(()=>{try{const t=f.value;if(!o.test(t))throw new Error("invalid MIDI number");const e=P(Number(t)),i=c(e);y(),w=e,C(r(e)),R(i),p.update(i)}catch(t){M(f,t.message)}})),v.addEventListener("focus",x,!1),v.addEventListener("input",(()=>{try{const t=v.value,e=P(function(t){const e=n.exec(t);if(!e||!Object.hasOwn(s,e[1]))throw new Error("invalid note name");return 12+Math.trunc(12*Number(e[2]))+s[e[1]]}(t)),i=c(e);E=i,y(),L(e),b=t,R(i),p.update(i)}catch(t){M(v,t.message)}})),g.addEventListener("focus",x,!1),g.addEventListener("input",(()=>{try{const t=g.value;if(!u.test(t))throw new Error("invalid frequency value");const e=Number(t.replace(",",".")),i=P(a(e)),n=A(i,e);y(),L(i,n),C(r(i),n),E=e,p.update(e)}catch(t){M(g,t.message)}}));const k=document.getElementById("record-button");k.addEventListener("click",(async()=>{const e=await async function(){return T??=await t.create({context:B(),processor:"listener",callbacks:{bin(t){I.shift(),I.push(1-(1-t)**5),m.update(I)},pitch(t){const e=Math.round(a(t));if(e<21||e>127)return;const i=A(e,t);y(),L(e,i),C(r(e),i),R(t,0),p.update(t)}}})}();var i;e.toggleEnabled(),i=e.isEnabled,f.disabled=v.disabled=g.disabled=i,k.classList.toggle("button--active",e.isEnabled),e.isEnabled||m.clear()}));document.getElementById("ping-button").addEventListener("click",(()=>{(S??=h.create(B())).emit(E)}));const I=new Array(16).fill(0);let F,S,T;function B(){return F??=new AudioContext}}));
