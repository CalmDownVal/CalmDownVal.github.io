<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="description" content="Converter between MIDI values, note names and frequencies.">
		<meta name="keywords" content="midi,frequency,note,music,production">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="author" content="@CalmDownVal">
		<title>
			MIDI, Note and Frequency Converter
		</title>
		<style media="screen">

@import url('https://fonts.googleapis.com/css2?family=Raleway:wght@400&display=swap');

* {
	padding: 0;
	margin: 0;
	font: inherit;
	color: inherit;
	cursor: inherit;
}

html {
	-webkit-text-size-adjust: 100%;
}

body {
	font-family: 'Raleway', sans-serif;
	font-weight: 400;
	user-select: none;
	background: #32322c;
	color: #fff;
	cursor: default;
	padding-bottom: 7rem;
}

a {
	cursor: pointer;
	text-decoration: underline;
}


.layout {
	position: fixed;
	inset: 0;
	display: flex;
	flex-direction: column;
	align-items: stretch;
	align-content: center;
	gap: 1rem;
	padding: 1rem;
	overflow-y: auto;
}


.page-header {
	display: none;
}

.page-footer {
	height: 3rem;
	text-align: center;
	color: rgba(255, 255, 255, .7);
}


.input-wrapper {
	--color: #666;

	flex-basis: 30%;
	position: relative;
	z-index: 100;
	display: block;
	min-height: 10rem;
	max-height: 10rem;
	background: var(--color);
	color: #000;
	box-shadow: 0 5px 15px rgba(0, 0, 0, .3);
	border-radius: .3rem;
	transition: box-shadow .3s linear;
	cursor: pointer;
}

.input-wrapper:focus-within {
	z-index: 200;
	box-shadow: 0 0 30px var(--color);
}

.input-wrapper__header,
.input-wrapper > .error {
	position: absolute;
	inset: 2rem 0 auto 2rem;
	font-size: 1.2rem;
}

.input-wrapper__input {
	position: absolute;
	inset: auto 2rem 2rem 0;
	border: none;
	padding: 0;
	width: auto;
	outline: none;
	font-size: 3rem;
	text-align: right;
	background: transparent;
}

.input-wrapper__input::selection {
	background: rgba(255, 255, 255, .5);
}

#midi-box { --color: #39a0ed; }
#note-box { --color: #36f1cd; }
#freq-box { --color: #ffe066; }

.input-wrapper > .error {
	background: var(--color);
	text-shadow: 0 0 8px #f25f5c;
}


#chart-wrapper {
	position: absolute;
	inset: auto 2rem 0 2rem;
	height: 1.5rem;
	overflow: hidden;
}


@media (min-width: 600px) {
	.layout {
		flex-flow: row wrap;
		align-items: center;
		justify-content: center;
	}

	.page-footer {
		flex-basis: 100%;
	}

	.input-wrapper {
		max-width: 20rem;
	}
}

@media (min-width: 600px) and (max-width: 800px) {
	.input-wrapper__input {
		right: 1rem;
	}
}

@media (min-height: 38rem) {
	.layout {
		/* center items vertically once vertical scrolling is not an issue */
		/* 3 * 10rem for input boxes + 3rem footer + 3 * 1rem gaps + 2 * 1rem padding = 38rem */
		justify-content: center;
	}
}

		</style>
	</head>
	<body>
		<header class="page-header">
			<h1>
				MIDI, Note and Frequency Converter
			</h1>
		</header>
		<section class="layout">
			<label class="input-wrapper" id="midi-box">
				<h2 class="input-wrapper__header">
					MIDI
				</h2>
				<input type="text" class="input-wrapper__input" id="midi-input" value="69" maxlength="8" inputMode="decimal">
			</label>
			<label class="input-wrapper" id="note-box">
				<h2 class="input-wrapper__header">
					note
				</h2>
				<input type="text" class="input-wrapper__input" id="note-input" value="A5" maxlength="8">
			</label>
			<label class="input-wrapper" id="freq-box">
				<h2 class="input-wrapper__header">
					frequency
				</h2>
				<input type="text" class="input-wrapper__input" id="freq-input" value="440" maxlength="8" inputMode="decimal">
				<div id="chart-wrapper">
					<canvas id="chart-canvas"></canvas>
				</div>
			</label>
			<footer class="page-footer">
				MIDI, Note and Frequency Converter
				&bull;
				by <a href="https://twitter.com/CalmDownVal" target="_blank">@CalmDownVal</a>
				&bull;
				2023
			</footer>
		</section>
	</body>
	<script>

(() => {
	const RE_INTEGER = /^-?\d+$/;
	const RE_FLOAT = /^-?\d+(?:[.,]\d*)?$/;
	const RE_NOTE = /^([a-g]#?)(\d+)$/i;
	const NOTE = {
		'a':   9, 'A':   9,
		'a#': 10, 'A#': 10,
		'b':  11, 'B':  11,
		'c':   0, 'C':   0,
		'c#':  1, 'C#':  1,
		'd':   2, 'D':   2,
		'd#':  3, 'D#':  3,
		'e':   4, 'E':   4,
		'f':   5, 'F':   5,
		'f#':  6, 'F#':  6,
		'g':   7, 'G':   7,
		'g#':  8, 'G#':  8
	};
	const ETON = [
		'C', 'C#', 'D', 'D#',
		'E', 'F', 'F#', 'G',
		'G#', 'A', 'A#', 'B'
	];


	// get form inputs

	const midiInput = document.querySelector('#midi-input');
	const noteInput = document.querySelector('#note-input');
	const freqInput = document.querySelector('#freq-input');

	function onFocus() {
		this.setSelectionRange(0, this.value.length);
	}

	midiInput.addEventListener('focus', onFocus, false);
	noteInput.addEventListener('focus', onFocus, false);
	freqInput.addEventListener('focus', onFocus, false);


	// setup error reporting

	function clearErrors(parent = document) {
		parent
			.querySelectorAll('.error')
			.forEach(node => {
				node.parentNode.removeChild(node);
			});
	}

	function setError(inputNode, text) {
		clearErrors(inputNode.parentNode);
		const node = document.createElement('span');
		node.classList.add('error');
		node.textContent = text;
		inputNode.parentNode.insertBefore(node, inputNode);
	}


	// calculations

	function noteToMidi(note) {
		const match = RE_NOTE.exec(note);
		if (!(match && Object.hasOwn(NOTE, match[1]))) {
			throw new Error('invalid note name');
		}

		return 12 + Math.trunc(Number(match[2]) * 12) + NOTE[match[1]];
	}

	function frequencyToMidi(freq, tuning = 440) {
		return 12 * Math.log(freq / tuning) / Math.LN2 + 69;
	}

	function midiToNote(midi) {
		return ETON[midi % 12] + Math.floor(midi / 12 - 1);
	}

	function midiToFrequency(midi, tuning = 440) {
		return Math.round(100.0 * Math.pow(2.0, (midi - 69) / 12.0) * tuning) / 100.0;
	}


	// form interactions

	midiInput.addEventListener('input', () => {
		try {
			const input = midiInput.value;
			if (!RE_INTEGER.test(input)) {
				throw new Error('invalid MIDI number');
			}

			const midi = clampMidi(Number(input));

			clearErrors();
			clearChart();
			setNote(midiToNote(midi));
			setFrequency(midiToFrequency(midi));
		}
		catch (ex) {
			setError(midiInput, ex.message);
		}
	});

	noteInput.addEventListener('input', () => {
		try {
			const midi = clampMidi(noteToMidi(noteInput.value));

			clearErrors();
			clearChart();
			setMidi(midi);
			setFrequency(midiToFrequency(midi));
		}
		catch (ex) {
			setError(noteInput, ex.message);
		}
	});

	freqInput.addEventListener('input', () => {
		try {
			const input = freqInput.value;
			if (!RE_FLOAT.test(input)) {
				throw new Error('invalid frequency value');
			}

			const freq = Number(input.replace(',', '.'));
			const midi = clampMidi(frequencyToMidi(freq));

			clearErrors();
			renderChart(freq);
			setMidi(midi);
			setNote(midiToNote(midi));
		}
		catch (ex) {
			setError(freqInput, ex.message);
		}
	});

	function clampMidi(midi) {
		const rounded = Math.round(midi);
		if (rounded < 21) {
			throw new Error('value too low');
		}

		if (rounded > 127) {
			throw new Error('value too high');
		}

		return rounded;
	}

	function setMidi(midi) {
		midiInput.value = midi.toFixed(0);
	}

	function setNote(note) {
		noteInput.value = note;
	}

	function setFrequency(freq) {
		freqInput.value = freq.toFixed(2);
	}


	// rounding chart

	const chartWrapper = document.querySelector('#chart-wrapper');
	const chartCanvas = document.querySelector('#chart-canvas');
	const chartContext = chartCanvas.getContext('2d');

	let chartWidth = 100;
	let chartHeight = 10;

	function renderChart(freq, tuning = 440) {
		const midi = Math.round(frequencyToMidi(freq, tuning));

		// get nearest surrounding notes as frequencies
		let freqLow = midiToFrequency(midi, tuning);
		let freqHigh;
		if (freq < freqLow) {
			freqHigh = freqLow;
			freqLow = midiToFrequency(midi - 1, tuning);
		}
		else {
			freqHigh = midiToFrequency(midi + 1, tuning);
		}

		layoutChart();
		clearChart();

		const distLow = freq - freqLow;
		const distHigh = freqHigh - freq;
		if (Math.min(distLow, distHigh) < Number.EPSILON) {
			return;
		}

		const ctx = chartContext;
		const r1 = 5 * devicePixelRatio;
		const r2 = 7 * devicePixelRatio;
		const w = chartWidth;
		const h = chartHeight;
		const mx = r1 + Math.round((w - 2 * r1) * distLow / (freqHigh - freqLow));
		const my = Math.round(h / 2);

		ctx.translate(0.5, 0.5);
		ctx.strokeStyle = 'black';
		ctx.fillStyle = 'black';

		ctx.lineWidth = (distLow < distHigh ? 2 : 1) * devicePixelRatio;
		ctx.beginPath();
		ctx.moveTo(r1, my - r2);
		ctx.lineTo(r1, my + r2);
		ctx.moveTo(r1, my);
		ctx.lineTo(mx, my);
		ctx.stroke();

		ctx.lineWidth = (distHigh < distLow ? 2 : 1) * devicePixelRatio;
		ctx.beginPath();
		ctx.moveTo(w - r1, my - r2);
		ctx.lineTo(w - r1, my + r2);
		ctx.moveTo(w - r1, my);
		ctx.lineTo(mx, my);
		ctx.stroke();

		ctx.beginPath();
		ctx.arc(mx, my, r1, 0, 2 * Math.PI, false);
		ctx.fill();

		ctx.translate(-0.5, -0.5);
	}

	function layoutChart() {
		const box = chartWrapper.getBoundingClientRect();
		chartWidth = Math.floor(box.width * devicePixelRatio);
		chartHeight = Math.floor(box.height * devicePixelRatio);

		chartCanvas.width = chartWidth;
		chartCanvas.height = chartHeight;
		chartCanvas.style.width = `${box.width}px`;
		chartCanvas.style.height = `${box.height}px`;
	}

	function clearChart() {
		chartContext.clearRect(0, 0, chartWidth, chartHeight);
	}

	window.addEventListener('DOMContentLoaded', layoutChart);
})();

	</script>
</html>
